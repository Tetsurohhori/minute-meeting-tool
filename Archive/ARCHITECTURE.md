# システムアーキテクチャ

議事メモRAGチャットボットのアーキテクチャと設計思想について説明します。

## 🏗 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     Streamlit Web UI (app.py)               │
│                     ユーザーインターフェース                   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  RAG Chat Engine                            │
│              (src/rag/chat_engine.py)                       │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ LangChain    │    │ OpenAI       │    │ Conversation │  │
│  │ RAG Chain    │    │ Chat Model   │    │ Memory       │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Vector Store Manager                           │
│          (src/vector_store/manager.py)                      │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ ChromaDB     │    │ OpenAI       │    │ Diff         │  │
│  │ Vector Store │    │ Embeddings   │    │ Detector     │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Data Source Layer (抽象化)                      │
│            (src/data_sources/base.py)                       │
│  ┌─────────────────────┐    ┌──────────────────────────┐   │
│  │ Google Drive        │    │ SharePoint               │   │
│  │ DataSource          │    │ DataSource               │   │
│  └─────────────────────┘    └──────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Google Drive    │    │   SharePoint     │
    │  (プロトタイプ)   │    │   (本番環境)     │
    └──────────────────┘    └──────────────────┘
```

## 📦 モジュール構成

### 1. Configuration Layer (`config/`)

**責務**: アプリケーション全体の設定管理

- `settings.py`: 環境変数の読み込みと検証
- シングルトンパターンで設定を一元管理
- データソースの切り替えをサポート

```python
settings = get_settings()
# 設定値にアクセス
api_key = settings.openai_api_key
data_source = settings.data_source
```

### 2. Data Source Layer (`src/data_sources/`)

**責務**: 外部データソースからのドキュメント取得

#### 設計パターン: Strategy Pattern (戦略パターン)

- `base.py`: データソースの抽象基底クラス
- `google_drive.py`: Google Drive実装
- `sharepoint.py`: SharePoint実装

#### インターフェース

```python
class DataSourceBase(ABC):
    @abstractmethod
    def authenticate(self) -> bool
    
    @abstractmethod
    def list_documents(self) -> List[DocumentInfo]
    
    @abstractmethod
    def get_document_content(self, file_id: str) -> str
```

#### 利点

1. **切り替え容易性**: 環境変数一つで切り替え可能
2. **拡張性**: 新しいデータソース（OneDrive等）の追加が容易
3. **テスタビリティ**: モックデータソースでのテストが可能

### 3. Vector Store Layer (`src/vector_store/`)

**責務**: ドキュメントのベクトル化と検索

#### 主要コンポーネント

##### VectorStoreManager

- ChromaDBとの連携
- OpenAI Embeddingsでのベクトル化
- ドキュメントの追加・更新・削除

##### 処理フロー

```
ドキュメント取得
    ↓
テキスト分割 (RecursiveCharacterTextSplitter)
    ↓
ベクトル化 (OpenAI Embeddings)
    ↓
ChromaDBに保存
    ↓
メタデータ更新
```

##### チャンク戦略

- デフォルト: 1000文字/チャンク、200文字オーバーラップ
- 理由: 
  - 1000文字: 文脈を保ちつつ、検索精度を維持
  - 200文字オーバーラップ: チャンク境界での情報損失を防ぐ

### 4. Differential Update (`src/utils/diff_detector.py`)

**責務**: 差分検出と増分更新

#### 仕組み

1. **ハッシュベースの変更検出**
   - SHA-256でコンテンツのハッシュ値を計算
   - 前回のハッシュ値と比較

2. **メタデータ管理**
   - JSON形式でファイル情報を保存
   - file_id、content_hash、modified_timeを記録

3. **更新戦略**
   ```python
   新規ファイル → 追加
   更新ファイル → 削除 + 再追加
   削除ファイル → 削除 + メタデータ削除
   ```

#### 効率性

- 変更のないファイルはスキップ
- APIコスト削減（Embeddingsの再計算を回避）
- 処理時間の短縮

### 5. RAG Engine (`src/rag/`)

**責務**: 質問応答システムの実装

#### RAGアーキテクチャ

```
質問
  ↓
ベクターストアで類似検索 (Retrieval)
  ↓
関連チャンクを取得 (Top-K)
  ↓
プロンプトに組み込み (Augmentation)
  ↓
LLMで回答生成 (Generation)
  ↓
回答 + ソース情報
```

#### 主要機能

1. **ConversationalRetrievalChain**
   - 会話履歴を考慮した検索
   - 文脈を保持した質問応答

2. **カスタムプロンプト**
   - 議事メモに特化したシステムプロンプト
   - ソース明記の指示
   - 推測防止の指示

3. **メモリ管理**
   - ConversationBufferMemory
   - 会話履歴の保持とクリア機能

### 6. Web Interface (`app.py`)

**責務**: ユーザーインターフェース

#### Streamlitの活用

- リアクティブなUI
- チャット形式のインターフェース
- セッション管理

#### 主要機能

1. **チャット履歴**
   - `st.session_state`で管理
   - ページリロード時も保持

2. **ソース表示**
   - 回答の根拠を明示
   - 参照元ドキュメントの表示

3. **統計情報**
   - ドキュメント数
   - チャンク数
   - モデル情報

## 🔄 データフロー

### 初回セットアップ時

```
1. 設定読み込み (.env)
   ↓
2. データソース初期化
   ↓
3. 認証実行
   ↓
4. 全ドキュメント取得
   ↓
5. ベクトル化・保存
   ↓
6. メタデータ記録
```

### 日次更新時

```
1. 現在のドキュメント一覧取得
   ↓
2. メタデータと比較
   ↓
3. 差分検出 (新規/更新/削除)
   ↓
4. 差分のみ処理
   ↓
5. メタデータ更新
```

### チャット実行時

```
1. ユーザーが質問入力
   ↓
2. ベクターストアで類似検索
   ↓
3. Top-K件のチャンク取得
   ↓
4. プロンプト構築
   ↓
5. LLMに送信
   ↓
6. 回答生成
   ↓
7. ソース情報と共に表示
```

## 🎯 設計の特徴

### 1. モジュラー設計

- 各レイヤーが独立
- インターフェースで結合
- 依存性の注入 (DI)

### 2. 拡張性

**新しいデータソースの追加**:
```python
class NewDataSource(DataSourceBase):
    def authenticate(self):
        # 実装
    
    def list_documents(self):
        # 実装
```

**新しいベクトルストアの追加**:
- VectorStoreManagerを継承
- 異なるDBに対応（Pinecone、Weaviate等）

### 3. 保守性

- 明確な責務分離
- 詳細なロギング
- エラーハンドリング

### 4. パフォーマンス

- キャッシング（Streamlitの@st.cache_resource）
- 差分更新による効率化
- バッチ処理

## 🔐 セキュリティ考慮事項

### 1. 認証情報の管理

- 環境変数で管理
- `.gitignore`でファイルを除外
- トークンの自動更新

### 2. APIキーの保護

- 環境変数に格納
- ハードコーディング禁止
- ログに出力しない

### 3. データの暗号化

- 通信: HTTPS（Google/SharePoint API）
- 保存: ファイルシステムのアクセス制御に依存

## 🚀 スケーラビリティ

### 現在の制限

- シングルユーザー
- ローカル実行
- ローカルベクトルストア

### 将来の拡張案

1. **マルチユーザー対応**
   - 認証レイヤーの追加
   - ユーザー別のベクトルストア

2. **クラウド展開**
   - Docker化
   - Pinecone等のクラウドベクトルDB
   - スケーラブルなホスティング

3. **パフォーマンス向上**
   - 非同期処理
   - キャッシュレイヤー
   - 分散処理

## 📊 メトリクス

### 監視すべき指標

1. **処理時間**
   - ドキュメント取得時間
   - ベクトル化時間
   - 検索レスポンス時間

2. **コスト**
   - OpenAI API使用量
   - Embeddings API呼び出し数
   - Chat API呼び出し数

3. **精度**
   - 回答の関連性
   - ソースの適切性

## 🔧 カスタマイズポイント

### 1. チャンクサイズの調整

```python
# .env
CHUNK_SIZE=1500  # デフォルト: 1000
CHUNK_OVERLAP=300  # デフォルト: 200
```

### 2. 検索結果数の調整

```python
# .env
TOP_K_RESULTS=10  # デフォルト: 5
```

### 3. モデルの変更

```python
# .env
CHAT_MODEL=gpt-4  # より高精度
EMBEDDING_MODEL=text-embedding-3-large  # より高次元
```

### 4. プロンプトのカスタマイズ

`src/rag/chat_engine.py`の`SYSTEM_PROMPT`を編集

---

**最終更新**: 2024年12月15日

